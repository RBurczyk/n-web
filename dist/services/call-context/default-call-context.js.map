{"version":3,"file":"default-call-context.js","sourceRoot":"","sources":["../../../src/services/call-context/default-call-context.ts"],"names":[],"mappings":";;AAEA,6CAAoC;AAGpC,iBAAe;AAGf;IAAA;QAKY,aAAQ,GAAY,KAAK,CAAC;IAoEtC,CAAC;IA/DG,IAAW,eAAe,KAAY,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC;IACrE,IAAW,UAAU,KAAa,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC;IAC5D,IAAW,WAAW,KAAa,MAAM,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC;IAC9D,IAAW,OAAO,KAAc,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC;IACvD,IAAW,UAAU,KAAa,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC;IAC5D,IAAW,SAAS,KAAa,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC;IAC1D,IAAW,eAAe,KAAc,MAAM,CAAC,IAAI,CAAC,QAAQ,KAAK,SAAS,IAAI,IAAI,CAAC,QAAQ,KAAK,IAAI,CAAC,CAAC,CAAC;IACvG,IAAW,QAAQ,KAAqB,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC,CAAC;IAGnE,SAAS,CAAC,GAAgB;QAE7B,mBAAK,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC,cAAc,EAAE,CAAC;QAEnC,IAAI,CAAC,IAAI,GAAG,GAAG,CAAC;QAChB,IAAI,CAAC,0BAA0B,EAAE,CAAC;QAClC,IAAI,CAAC,sBAAsB,EAAE,CAAC;IAClC,CAAC;IAGM,eAAe,CAAC,YAAoB;QAEvC,mBAAK,CAAC,YAAY,EAAE,cAAc,CAAC;aAC9B,cAAc,EAAE;aAChB,cAAc,EAAE;aAChB,MAAM,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,mBAAmB,EAAE,CAAC,CAAC;QAE3C,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAI,GAAG,YAAY,CAAC,IAAI,EAAE,CAAC;IAClD,CAAC;IAGO,0BAA0B;QAE9B,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,GAAG,IAAI,CAAC;QAC1F,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,GAAG,IAAI,CAAC;IAC7F,CAAC;IAEO,sBAAsB;QAE1B,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,IAAI,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,CACvD,CAAC;YACG,IAAI,aAAa,GAAW,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC;YAC3D,EAAE,CAAC,CAAC,CAAC,aAAa,CAAC,mBAAmB,EAAE,CAAC,CACzC,CAAC;gBACG,aAAa,GAAG,aAAa,CAAC,IAAI,EAAE,CAAC;gBACrC,OAAO,aAAa,CAAC,QAAQ,CAAC,IAAI,CAAC;oBAC/B,aAAa,GAAG,aAAa,CAAC,UAAU,CAAC,IAAI,EAAE,GAAG,CAAC,CAAC;gBAExD,IAAI,QAAQ,GAAG,aAAa,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;gBACxC,EAAE,CAAC,CAAC,QAAQ,CAAC,MAAM,KAAK,CAAC,CAAC,CAC1B,CAAC;oBACG,IAAI,MAAM,GAAG,QAAQ,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC,WAAW,EAAE,CAAC;oBAC9C,IAAI,KAAK,GAAG,QAAQ,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC;oBAC/B,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,mBAAmB,EAAE,IAAI,CAAC,KAAK,CAAC,mBAAmB,EAAE,CAAC,CAClE,CAAC;wBACG,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;wBACrB,IAAI,CAAC,WAAW,GAAG,MAAM,CAAC;wBAC1B,IAAI,CAAC,UAAU,GAAG,KAAK,CAAC;oBAC5B,CAAC;gBACL,CAAC;YACL,CAAC;QACL,CAAC;IACL,CAAC;CACJ;AAzED,gDAyEC","sourcesContent":["import { CallContext } from \"./call-context\";\nimport { Scope } from \"n-ject\";\nimport { given } from \"n-defensive\";\nimport * as Koa from \"koa\";\nimport { ClaimsIdentity } from \"n-sec\";\nimport \"n-ext\";\n\n\nexport class DefaultCallContext implements CallContext\n{\n    private _ctx: Koa.Context;\n    private _pathParams: Object;\n    private _queryParams: Object;\n    private _hasAuth: boolean = false;\n    private _authScheme: string;\n    private _authToken: string;\n    \n    \n    public get dependencyScope(): Scope { return this._ctx.state.scope; }\n    public get pathParams(): Object { return this._pathParams; }\n    public get queryParams(): Object { return this._queryParams; }\n    public get hasAuth(): boolean { return this._hasAuth; }\n    public get authScheme(): string { return this._authScheme; }\n    public get authToken(): string { return this._authToken; }\n    public get isAuthenticated(): boolean { return this.identity !== undefined && this.identity !== null; }\n    public get identity(): ClaimsIdentity { return this._ctx.state.identity; }\n    \n    \n    public configure(ctx: Koa.Context): void\n    {\n        given(ctx, \"ctx\").ensureHasValue();\n        \n        this._ctx = ctx;\n        this.populatePathAndQueryParams();\n        this.populateSchemeAndToken();\n    }\n    \n    \n    public setResponseType(responseType: string): void\n    {\n        given(responseType, \"responseType\")\n            .ensureHasValue()\n            .ensureIsString()\n            .ensure(t => !t.isEmptyOrWhiteSpace());\n        \n        this._ctx.response.type = responseType.trim();\n    }\n    \n    \n    private populatePathAndQueryParams(): void\n    {\n        this._pathParams = this._ctx.params ? JSON.parse(JSON.stringify(this._ctx.params)) : null;\n        this._queryParams = this._ctx.query ? JSON.parse(JSON.stringify(this._ctx.query)) : null;\n    }\n    \n    private populateSchemeAndToken(): void\n    {\n        if (this._ctx.header && this._ctx.header.authorization)\n        {\n            let authorization: string = this._ctx.header.authorization;\n            if (!authorization.isEmptyOrWhiteSpace())\n            {\n                authorization = authorization.trim();\n                while (authorization.contains(\"  \")) // double space\n                    authorization = authorization.replaceAll(\"  \", \" \");    \n                \n                let splitted = authorization.split(\" \");\n                if (splitted.length === 2)\n                {\n                    let scheme = splitted[0].trim().toLowerCase();\n                    let token = splitted[1].trim();\n                    if (!scheme.isEmptyOrWhiteSpace() && !token.isEmptyOrWhiteSpace())\n                    {\n                        this._hasAuth = true;\n                        this._authScheme = scheme;\n                        this._authToken = token;\n                    }\n                }\n            }\n        } \n    }\n}"]}